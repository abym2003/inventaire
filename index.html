<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#bb86fc">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Gestion d'Inventaire</title>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        /* [TOUS LES STYLES RESTENT IDENTIQUES] */
        /* ... styles inchang√©s ... */
        
        /* NOUVEAUX STYLES POUR LE SCANNER AM√âLIOR√â */
        .scanner-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .scanner-status {
            background: #1e1e1e;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #333;
            text-align: center;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .scanner-status.active {
            border-color: #03dac6;
            background: rgba(3, 218, 198, 0.1);
        }
        
        .camera-permission-saved {
            font-size: 12px;
            color: #03dac6;
            margin-top: 4px;
            text-align: center;
        }

        /* Bouton retour scanner */
        .back-to-scanner-btn {
            position: fixed;
            top: 16px;
            left: 20px;
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid #333;
            color: #bb86fc;
            border-radius: 12px;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 9999;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        
        .back-to-scanner-btn:hover {
            background: rgba(30, 30, 30, 1);
            border-color: #bb86fc;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(187, 134, 252, 0.3);
        }
        
        /* Nouveau style pour le scanner pr√©par√© */
        .scanner-prepared {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 300px;
            background: linear-gradient(135deg, #1e1e1e 0%, #252525 100%);
            border-radius: 12px;
            border: 2px dashed #333;
            color: #888;
            font-size: 16px;
            flex-direction: column;
            gap: 12px;
        }
        
        .scanner-prepared .icon {
            font-size: 48px;
        }
    </style>
</head>
<body>
    <!-- [TOUT LE HTML RESTE IDENTIQUE] -->
    <!-- ... html inchang√© ... -->
    
    <div id="scan-page" class="page hidden">
        <div class="header">
            <h1>üì∑ Scanner</h1>
            <div class="header-subtitle">Scanner un code-barre</div>
        </div>
        <div class="container">
            <div class="scanner-status" id="scanner-status">
                <div>üì∑</div>
                <div id="status-text">Scanner pr√™t</div>
            </div>

            <!-- Conteneur scanner am√©lior√© -->
            <div class="scanner-container" id="scanner-reader">
                <div id="scan-feedback" class="scan-feedback"></div>
                <!-- √âtat pr√©par√© quand le scanner n'est pas actif -->
                <div id="scanner-prepared" class="scanner-prepared" style="display: none;">
                    <div class="icon">üì∑</div>
                    <div>Scanner pr√™t - Cliquez sur "D√©marrer"</div>
                </div>
            </div>
            
            <div class="scanner-controls">
                <button class="btn-primary" onclick="startScanner()" id="start-scanner-btn">
                    ‚ñ∂Ô∏è D√©marrer le scanner
                </button>
                <button class="btn-secondary" onclick="stopScanner()" id="stop-scanner-btn" style="display: none;">
                    ‚è∏Ô∏è Arr√™ter
                </button>
                <button class="btn-secondary" onclick="toggleCamera()" id="toggle-camera-btn" style="display: none;">
                    üîÑ Changer cam√©ra
                </button>
            </div>

            <div class="detail-section">
                <div class="section-title">üì± Scanner manuelle</div>
                <div class="form-group">
                    <input type="text" class="form-input" id="manual-barcode" placeholder="Entrez le code-barre manuellement" onkeypress="if(event.key === 'Enter') searchByBarcode()">
                </div>
                <button class="btn-primary" onclick="searchByBarcode()">Rechercher</button>
            </div>

            <div id="scan-result"></div>
        </div>
    </div>
    
    <!-- [TOUT LE RESTE DU HTML RESTE IDENTIQUE] -->
    <!-- ... html inchang√© ... -->

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let articles = JSON.parse(localStorage.getItem('inventory_articles')) || [];
        let locations = JSON.parse(localStorage.getItem('inventory_locations')) || [];
        let history = JSON.parse(localStorage.getItem('inventory_history')) || [];
        let currentArticleId = null;
        let currentStockAction = null;
        let html5QrCode = null;
        let isScannerActive = false;
        let cameraPermissionGranted = localStorage.getItem('cameraPermission') === 'granted';
        let currentCameraId = null;
        let cameras = [];
        
        let currentFilters = {
            location: null,
            famille: null,
            categorie: null,
            fournisseur: null
        };

        if (locations.length === 0) {
            locations = [
                { id: Date.now(), name: 'Entrep√¥t principal', description: 'Stockage principal' },
                { id: Date.now() + 1, name: 'Bureau', description: 'Petit mat√©riel de bureau' },
                { id: Date.now() + 2, name: 'Atelier', description: 'Outils et √©quipements' }
            ];
            saveToStorage();
        }

        function navigateTo(page) {
            console.log('Navigating to:', page);
            
            // Arr√™ter le scanner si on quitte la page scan
            if (page !== 'scan' && isScannerActive) {
                stopScanner(true); // true = arr√™t silencieux
            }
            
            // Masquer le bouton retour scanner
            document.getElementById('back-to-scanner-btn').classList.add('hidden');
            
            // Masquer toutes les pages
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            
            // Afficher la page demand√©e
            document.getElementById(`${page}-page`).classList.remove('hidden');
            
            // G√©rer la navigation - TOUJOURS ACTIVER LE BOUTON CORRESPONDANT
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Activer le bouton correspondant √† la page
            if (page === 'detail') {
                // Pour la page d√©tail, activer l'inventaire car c'est de l√† qu'on vient
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (item.onclick && item.onclick.toString().includes(`navigateTo('inventory')`)) {
                        item.classList.add('active');
                    }
                });
                
                // Afficher le bouton retour scanner
                document.getElementById('back-to-scanner-btn').classList.remove('hidden');
            } else if (page === 'scan') {
                // Pour la page scan, afficher l'√©tat pr√©par√©
                showScannerPreparedState();
                
                // Si permission accord√©e, afficher seulement le bouton de d√©marrage
                if (cameraPermissionGranted) {
                    document.getElementById('start-scanner-btn').style.display = 'block';
                    document.getElementById('stop-scanner-btn').style.display = 'none';
                    document.getElementById('toggle-camera-btn').style.display = 'none';
                }
            } else {
                // Page normale : activer le bouton correspondant
                document.querySelectorAll('.nav-item').forEach(item => {
                    if (item.onclick && item.onclick.toString().includes(`navigateTo('${page}')`)) {
                        item.classList.add('active');
                    }
                });
            }
            
            // Charger les donn√©es sp√©cifiques √† la page
            if (page === 'dashboard') loadDashboard();
            if (page === 'inventory') loadInventory();
            if (page === 'search') loadSearchPage();
            if (page === 'locations') loadLocations();
            if (page === 'import-export') loadImportExport();
        }

        function returnToScanner() {
            // Nettoyer le conteneur de d√©tails
            document.getElementById('detail-container').innerHTML = '';
            // Retourner au scanner
            navigateTo('scan');
        }

        function saveToStorage() {
            localStorage.setItem('inventory_articles', JSON.stringify(articles));
            localStorage.setItem('inventory_locations', JSON.stringify(locations));
            localStorage.setItem('inventory_history', JSON.stringify(history));
        }

        // FONCTIONS AM√âLIOR√âES POUR LE SCANNER
        async function startScanner() {
            console.log('D√©marrage du scanner...');
            
            // Arr√™ter le scanner s'il est d√©j√† actif
            if (isScannerActive) {
                await stopScanner(true);
            }
            
            // Nettoyer le conteneur du scanner
            const scannerReader = document.getElementById('scanner-reader');
            scannerReader.innerHTML = '<div id="scan-feedback" class="scan-feedback"></div>';
            
            // Masquer l'√©tat pr√©par√©
            document.getElementById('scanner-prepared').style.display = 'none';
            
            // Mettre √† jour l'interface
            document.getElementById('start-scanner-btn').style.display = 'none';
            document.getElementById('stop-scanner-btn').style.display = 'block';
            document.getElementById('toggle-camera-btn').style.display = 'block';
            document.getElementById('scanner-status').classList.add('active');
            document.getElementById('status-text').textContent = 'Scanner actif';
            
            try {
                // Cr√©er une nouvelle instance du scanner
                html5QrCode = new Html5Qrcode("scanner-reader");
                
                // Obtenir la liste des cam√©ras
                const devices = await Html5Qrcode.getCameras();
                cameras = devices;
                
                if (cameras.length === 0) {
                    throw new Error("Aucune cam√©ra disponible");
                }
                
                // Utiliser la cam√©ra par d√©faut ou la derni√®re utilis√©e
                let cameraId = currentCameraId || cameras[0].id;
                
                // Configuration du scanner
                const config = {
                    fps: 10,
                    qrbox: { width: 250, height: 150 },
                    aspectRatio: 1.0,
                    disableFlip: false
                };
                
                // D√©marrer le scanner
                await html5QrCode.start(
                    cameraId,
                    config,
                    (decodedText) => {
                        onScanSuccess(decodedText);
                    },
                    (errorMessage) => {
                        // Ne rien faire pour les erreurs de scanning (continuer √† scanner)
                    }
                );
                
                isScannerActive = true;
                cameraPermissionGranted = true;
                localStorage.setItem('cameraPermission', 'granted');
                
                console.log('Scanner d√©marr√© avec succ√®s sur la cam√©ra:', cameraId);
                
            } catch (error) {
                console.error('Erreur d√©marrage scanner:', error);
                isScannerActive = false;
                
                // Afficher l'√©tat pr√©par√©
                showScannerPreparedState();
                
                // R√©afficher le bouton de d√©marrage
                document.getElementById('start-scanner-btn').style.display = 'block';
                document.getElementById('stop-scanner-btn').style.display = 'none';
                document.getElementById('toggle-camera-btn').style.display = 'none';
                document.getElementById('scanner-status').classList.remove('active');
                
                let errorMessage = 'Erreur de d√©marrage';
                if (error.message.includes('permission')) {
                    errorMessage = 'Permission cam√©ra refus√©e';
                    cameraPermissionGranted = false;
                    localStorage.setItem('cameraPermission', 'denied');
                } else if (error.message.includes('Aucune cam√©ra')) {
                    errorMessage = 'Aucune cam√©ra disponible';
                }
                
                document.getElementById('status-text').textContent = errorMessage;
                
                // Afficher un message d'erreur
                showScanFeedback(`‚ùå ${errorMessage}`, 'error');
            }
        }
        
        async function stopScanner(silent = false) {
            if (html5QrCode && isScannerActive) {
                console.log('Arr√™t du scanner...');
                
                try {
                    await html5QrCode.stop();
                    html5QrCode.clear();
                    html5QrCode = null;
                    isScannerActive = false;
                    
                    console.log('Scanner arr√™t√© avec succ√®s');
                    
                    if (!silent) {
                        // Afficher l'√©tat pr√©par√©
                        showScannerPreparedState();
                        
                        // Mettre √† jour l'interface
                        document.getElementById('start-scanner-btn').style.display = 'block';
                        document.getElementById('stop-scanner-btn').style.display = 'none';
                        document.getElementById('toggle-camera-btn').style.display = 'none';
                        document.getElementById('scanner-status').classList.remove('active');
                        document.getElementById('status-text').textContent = 'Scanner arr√™t√©';
                    }
                    
                } catch (error) {
                    console.log('Erreur arr√™t scanner:', error);
                    isScannerActive = false;
                    html5QrCode = null;
                    
                    if (!silent) {
                        // Mettre √† jour l'interface m√™me en cas d'erreur
                        document.getElementById('start-scanner-btn').style.display = 'block';
                        document.getElementById('stop-scanner-btn').style.display = 'none';
                        document.getElementById('toggle-camera-btn').style.display = 'none';
                        document.getElementById('scanner-status').classList.remove('active');
                        document.getElementById('status-text').textContent = 'Scanner arr√™t√©';
                    }
                }
            } else {
                // Si le scanner n'est pas actif, s'assurer que l'interface est correcte
                if (!silent) {
                    document.getElementById('start-scanner-btn').style.display = 'block';
                    document.getElementById('stop-scanner-btn').style.display = 'none';
                    document.getElementById('toggle-camera-btn').style.display = 'none';
                    document.getElementById('scanner-status').classList.remove('active');
                    document.getElementById('status-text').textContent = 'Scanner pr√™t';
                }
            }
        }
        
        async function toggleCamera() {
            if (!isScannerActive || cameras.length < 2) return;
            
            console.log('Changement de cam√©ra...');
            
            // Arr√™ter le scanner actuel
            await stopScanner(true);
            
            // Trouver l'index de la cam√©ra actuelle
            let currentIndex = 0;
            if (currentCameraId) {
                currentIndex = cameras.findIndex(cam => cam.id === currentCameraId);
            }
            
            // Passer √† la cam√©ra suivante
            let nextIndex = (currentIndex + 1) % cameras.length;
            currentCameraId = cameras[nextIndex].id;
            
            console.log('Passage √† la cam√©ra:', currentCameraId);
            
            // Red√©marrer le scanner avec la nouvelle cam√©ra
            await startScanner();
        }
        
        function showScannerPreparedState() {
            const scannerReader = document.getElementById('scanner-reader');
            scannerReader.innerHTML = `
                <div id="scan-feedback" class="scan-feedback"></div>
                <div id="scanner-prepared" class="scanner-prepared">
                    <div class="icon">üì∑</div>
                    <div>Scanner pr√™t - Cliquez sur "D√©marrer"</div>
                </div>
            `;
        }
        
        function onScanSuccess(decodedText) {
            console.log('Code scann√©:', decodedText);
            
            // Afficher un feedback visuel
            showScanFeedback('‚úÖ Code scann√© !');
            
            // Mettre le code dans le champ manuel
            document.getElementById('manual-barcode').value = decodedText;
            
            // Rechercher l'article
            const article = articles.find(a => a.barcode === decodedText);
            
            if (article) {
                console.log('Article trouv√©:', article);
                // Afficher les d√©tails de l'article apr√®s un court d√©lai
                setTimeout(() => {
                    showArticleDetail(article.id.toString());
                }, 800);
            } else {
                console.log('Article non trouv√©');
                // Afficher le modal de cr√©ation apr√®s un court d√©lai
                setTimeout(() => {
                    showAddArticleModal();
                    document.getElementById('article-barcode').value = decodedText;
                    document.getElementById('article-name').focus();
                    
                    // Afficher un message
                    document.getElementById('scan-result').innerHTML = `
                        <div class="detail-section">
                            <div class="section-title">‚ùå Article non trouv√©</div>
                            <div style="text-align: center; padding: 20px; color: #888;">
                                Aucun article avec le code "${decodedText}"
                                <br>Le formulaire de cr√©ation a √©t√© ouvert.
                            </div>
                        </div>
                    `;
                }, 800);
            }
        }
        
        function showScanFeedback(message, type = 'success') {
            const feedback = document.getElementById('scan-feedback');
            feedback.textContent = message;
            feedback.style.color = type === 'error' ? '#cf6679' : '#03dac6';
            feedback.classList.add('show');
            
            setTimeout(() => {
                feedback.classList.remove('show');
            }, 1500);
        }

        function searchByBarcode(barcode = null) {
            const scannedBarcode = barcode || document.getElementById('manual-barcode').value.trim();
            if (!scannedBarcode) return;

            console.log('Recherche manuelle de code-barre:', scannedBarcode);
            const article = articles.find(a => a.barcode === scannedBarcode);
            
            if (article) {
                console.log('Article trouv√© (manuel):', article);
                // Afficher les d√©tails de l'article
                showArticleDetail(article.id.toString());
            } else {
                console.log('Article non trouv√© (manuel)');
                // Afficher le modal de cr√©ation
                showAddArticleModal();
                document.getElementById('article-barcode').value = scannedBarcode;
                document.getElementById('article-name').focus();
                
                // Afficher un message
                if (!barcode) {
                    document.getElementById('scan-result').innerHTML = `
                        <div class="detail-section">
                            <div class="section-title">‚ùå Article non trouv√©</div>
                            <div style="text-align: center; padding: 20px; color: #888;">
                                Aucun article avec le code "${scannedBarcode}"
                                <br>Le formulaire de cr√©ation a √©t√© ouvert.
                            </div>
                        </div>
                    `;
                }
            }
        }

        // [TOUTES LES AUTRES FONCTIONS RESTENT IDENTIQUES]
        // ... fonctions inchang√©es ...

        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('input', loadInventory);
            }
            
            const advancedSearchInput = document.getElementById('advanced-search-input');
            if (advancedSearchInput) {
                advancedSearchInput.addEventListener('input', performAdvancedSearch);
            }
            
            // Initialiser les valeurs par d√©faut dans le modal d'ajout
            const addArticleModal = document.getElementById('add-article-modal');
            if (addArticleModal) {
                // Les valeurs sont d√©j√† pr√©remplies dans le HTML
            }
            
            // V√©rifier si la permission cam√©ra est d√©j√† accord√©e
            if (cameraPermissionGranted) {
                console.log('Permission cam√©ra d√©j√† accord√©e');
            }
        });

        loadDashboard();
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.error('Service Worker error:', err));
        }
    </script>
    <script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9a725f727c0be112","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.9.1","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#bb86fc">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Gestion d'Inventaire</title>
    <style>
        /* Tout le CSS original est ici */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #121212;
            color: #e0e0e0;
            overflow-x: hidden;
        }

        /* ... tout le reste du CSS ... */

        .hidden {
            display: none !important;
        }

        .detail-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .detail-info-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 4px;
        }

        .detail-info-value {
            font-size: 15px;
            color: #e0e0e0;
            font-weight: 500;
        }
		
		/* Styles pour la page recherche */
#search-instructions {
    margin-top: 40px;
    text-align: center;
    padding: 40px 20px;
}

#search-instructions .empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}

#search-instructions .empty-text {
    font-size: 15px;
    color: #aaa;
    line-height: 1.5;
}

/* Animation pour les r√©sultats */
#search-results-container {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
    </style>
</head>
<body>
    <div id="dashboard-page" class="page">
        <div class="header">
            <h1>üì¶ Gestion d'Inventaire</h1>
            <div class="header-subtitle">Tableau de bord</div>
        </div>
        <div class="container">
            <div class="stats-grid">
                <div class="stat-card" onclick="navigateTo('locations')">
                    <div class="stat-value" id="total-locations">0</div>
                    <div class="stat-label">Emplacement</div>
                </div>
                <div class="stat-card" onclick="showLowStock()">
                    <div class="stat-value" id="low-stock">0</div>
                    <div class="stat-label">Stock faible</div>
                </div>
            </div>

            <div class="quick-actions">
    <button class="action-btn" onclick="showAddArticleModal()">
        ‚ûï Ajouter article
    </button>
    <button class="action-btn secondary" onclick="navigateToWithScanner('scan')">
        üì∑ Scanner
    </button>
</div>

            <div class="detail-section">
                <div class="section-title">Activit√© r√©cente</div>
                <div id="recent-activity"></div>
            </div>
        </div>
    </div>

    <div id="inventory-page" class="page hidden">
        <div class="header">
            <h1>üìã Inventaire</h1>
            <div class="header-subtitle">Liste des articles</div>
        </div>
        <div class="container">
            <div class="search-container">
                <input type="text" class="search-input" id="search-input" placeholder="üîç Rechercher un article...">
            </div>

            <div class="filters" id="location-filters"></div>

            <div class="article-list" id="article-list"></div>
        </div>
        <button class="fab" onclick="showAddArticleModal()">+</button>
    </div>

    <div id="scan-page" class="page hidden">
    <div class="header">
        <h1>üì∑ Scanner</h1>
        <div class="header-subtitle">Scanner un code-barre</div>
    </div>
    <div class="container">
        <div class="scanner-container" id="scanner-reader"></div>

        <!-- BOUTONS DE CONTR√îLE DU SCANNER -->
        <div style="text-align: center; margin: 16px 0;">
            <button class="btn-secondary" onclick="stopScanner()" style="width: auto; padding: 8px 16px;">
                ‚è∏Ô∏è Arr√™ter le scanner
            </button>
            <button class="btn-secondary" onclick="initScanner()" style="width: auto; padding: 8px 16px; margin-left: 8px;">
                ‚ñ∂Ô∏è Red√©marrer
            </button>
        </div>

        <div class="detail-section">
            <div class="section-title">üì± Scanner manuel</div>
            <div class="form-group">
                <input type="text" class="form-input" id="manual-barcode" placeholder="Entrez le code-barre manuellement">
            </div>
            <button class="btn-primary" onclick="searchByBarcode()">Rechercher</button>
        </div>

        <div id="scan-result"></div>
    </div>
</div>
	
	<div id="search-page" class="page hidden">
    <div class="header">
        <h1>üîç Recherche Avanc√©e</h1>
        <div class="header-subtitle">Trouver des articles rapidement</div>
    </div>
    <div class="container">
        <!-- Section filtres d'emplacement en premier -->
        <div class="detail-section">
            <div class="section-title">üìç Filtrer par emplacement</div>
            <div class="filters" id="search-location-filters"></div>
        </div>

        <!-- Section filtres de statut de stock -->
        <div class="detail-section">
            <div class="section-title">üìä Filtrer par statut de stock</div>
            <div class="filters">
                <div class="filter-chip active" data-filter="all" onclick="filterSearchResults('all')">
                    Tous
                </div>
                <div class="filter-chip" data-filter="low" onclick="filterSearchResults('low')">
                    ‚ö†Ô∏è Stock faible
                </div>
                <div class="filter-chip" data-filter="zero" onclick="filterSearchResults('zero')">
                    ‚ùå Rupture
                </div>
            </div>
        </div>

        <!-- Champ de recherche apr√®s les filtres -->
        <div class="search-container" style="margin-top: 20px;">
            <input type="text" class="search-input" id="advanced-search-input" 
                   placeholder="üîç Rechercher par nom, code-barre, famille, cat√©gorie, fournisseur...">
        </div>

        <!-- Message d'instructions au lieu de liste vide -->
        <div id="search-instructions" class="empty-state">
            <div class="empty-icon">üîç</div>
            <div class="empty-text">
                <p style="margin-bottom: 12px;">Entrez un terme de recherche ci-dessus</p>
                <p style="font-size: 14px; color: #aaa;">
                    Vous pouvez rechercher par :<br>
                    ‚Ä¢ Nom d'article<br>
                    ‚Ä¢ Code-barre<br>
                    ‚Ä¢ Famille ou cat√©gorie<br>
                    ‚Ä¢ Fournisseur
                </p>
            </div>
        </div>

        <!-- Conteneur pour les r√©sultats (cach√© initialement) -->
        <div id="search-results-container" class="hidden">
            <div class="article-list" id="search-results"></div>
        </div>
    </div>
</div>

    <div id="detail-page" class="page hidden">
        <div class="header">
            <h1>üì¶ D√©tails</h1>
            <div class="header-subtitle">Information de l'article</div>
        </div>
        <div class="container" id="detail-container"></div>
    </div>

    <div id="locations-page" class="page hidden">
        <div class="header">
            <h1>üìç Emplacements</h1>
            <div class="header-subtitle">Gestion des lieux</div>
        </div>
        <div class="container">
            <div id="locations-list"></div>
        </div>
        <button class="fab" onclick="showAddLocationModal()">+</button>
    </div>

    <div id="import-export-page" class="page hidden">
        <div class="header">
            <h1>üìä Import/Export</h1>
            <div class="header-subtitle">Gestion des donn√©es</div>
        </div>
        <div class="container">
            <div class="export-section">
                <div class="export-icon">üì§</div>
                <div class="section-title">Exporter l'inventaire</div>
                <div class="form-group">
                    <label class="form-label">Adresse e-mail</label>
                    <input type="email" class="form-input" id="export-email" placeholder="votre@email.com">
                </div>
                <button class="btn-primary" onclick="exportToExcel()">üìß Exporter et envoyer</button>
                <button class="btn-secondary" onclick="downloadExcel()">üíæ T√©l√©charger Excel</button>
            </div>

            <div class="export-section">
                <div class="export-icon">üì•</div>
                <div class="section-title">Importer l'inventaire</div>
                <div class="file-input-wrapper">
                    <input type="file" id="import-file" accept=".xlsx,.xls,.csv" onchange="importFromExcel(event)">
                    <label for="import-file" class="file-input-label">
                        üìÅ S√©lectionner un fichier Excel
                    </label>
                </div>
                <div style="margin-top: 12px; font-size: 13px; color: #888; text-align: center;">
                    Formats accept√©s: .xlsx, .xls, .csv
                </div>
            </div>

            <div class="export-section">
                <div class="section-title">üíæ Sauvegarde locale</div>
                <button class="btn-secondary" onclick="backupData()">Cr√©er une sauvegarde</button>
                <button class="btn-secondary" onclick="restoreData()">Restaurer une sauvegarde</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
    <div class="nav-item active" onclick="navigateToWithScanner('dashboard')">
        <div class="nav-icon">üè†</div>
        <div class="nav-label">Accueil</div>
    </div>
    <div class="nav-item" onclick="navigateToWithScanner('inventory')">
        <div class="nav-icon">üìã</div>
        <div class="nav-label">Inventaire</div>
    </div>
    <div class="nav-item" onclick="navigateToWithScanner('search')">  
        <div class="nav-icon">üîç</div>  
        <div class="nav-label">Recherche</div>  
    </div>
    <div class="nav-item" onclick="navigateToWithScanner('locations')">
        <div class="nav-icon">üìç</div>
        <div class="nav-label">Lieux</div>
    </div>
    <div class="nav-item" onclick="navigateToWithScanner('import-export')">
        <div class="nav-icon">üìä</div>
        <div class="nav-label">Export</div>
    </div>
</nav>

    <div id="add-article-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Nouvel Article</div>
                <button class="close-btn" onclick="closeModal('add-article-modal')">&times;</button>
            </div>
            <form onsubmit="saveArticle(event)">
                <div class="form-group">
                    <label class="form-label">Code-barre</label>
                    <input type="text" class="form-input" id="article-barcode">
                </div>
                <div class="form-group">
                    <label class="form-label">Famille *</label>
                    <input type="text" class="form-input" id="article-famille" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Cat√©gorie *</label>
                    <input type="text" class="form-input" id="article-categorie" required>
                </div>
				<div class="form-group">
                    <label class="form-label">Nom de l'article *</label>
                    <input type="text" class="form-input" id="article-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Taille</label>
                    <input type="text" class="form-input" id="article-taille">
                </div>
                <div class="form-group">
                    <label class="form-label">Longueur</label>
                    <input type="text" class="form-input" id="article-longueur">
                </div>
                <div class="form-group">
                    <label class="form-label">Conditionnement *</label>
                    <input type="number" class="form-input" id="article-conditionnement" required min="1" value="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Fournisseur</label>
                    <input type="text" class="form-input" id="article-fournisseur">
                </div>
                <div class="form-group">
                    <label class="form-label">Lieu de stockage *</label>
                    <select class="form-select" id="article-location" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Nombre *</label>
                    <input type="number" class="form-input" id="article-nombre" required min="0" value="1">
                </div>
                <button type="submit" class="btn-primary">Enregistrer</button>
            </form>
        </div>
    </div>

    <div id="add-location-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Nouvel Emplacement</div>
                <button class="close-btn" onclick="closeModal('add-location-modal')">&times;</button>
            </div>
            <form onsubmit="saveLocation(event)">
                <div class="form-group">
                    <label class="form-label">Nom de l'emplacement *</label>
                    <input type="text" class="form-input" id="location-name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="location-description"></textarea>
                </div>
                <button type="submit" class="btn-primary">Enregistrer</button>
            </form>
        </div>
    </div>

    <div id="move-article-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">D√©placer l'article</div>
                <button class="close-btn" onclick="closeModal('move-article-modal')">&times;</button>
            </div>
            <form onsubmit="moveArticle(event)">
                <div class="form-group">
                    <label class="form-label">Depuis</label>
                    <select class="form-select" id="move-from" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Vers</label>
                    <select class="form-select" id="move-to" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <input type="number" class="form-input" id="move-quantity" min="1" required>
                </div>
                <button type="submit" class="btn-primary">D√©placer</button>
            </form>
        </div>
    </div>

    <div id="stock-action-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="stock-action-title">Action sur le stock</div>
                <button class="close-btn" onclick="closeModal('stock-action-modal')">&times;</button>
            </div>
            <form onsubmit="performStockAction(event)">
                <div class="form-group">
                    <label class="form-label">Emplacement</label>
                    <select class="form-select" id="stock-location" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <input type="number" class="form-input" id="stock-quantity" min="1" required>
                </div>
                <button type="submit" class="btn-primary" id="stock-action-btn">Confirmer</button>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
    let articles = JSON.parse(localStorage.getItem('inventory_articles')) || [];
    let locations = JSON.parse(localStorage.getItem('inventory_locations')) || [];
    let history = JSON.parse(localStorage.getItem('inventory_history')) || [];
    let currentArticleId = null;
    let currentStockAction = null;
    let html5QrCode = null;

    if (locations.length === 0) {
        locations = [
            { id: Date.now(), name: 'Entrep√¥t principal', description: 'Stockage principal' },
            { id: Date.now() + 1, name: 'Bureau', description: 'Petit mat√©riel de bureau' },
            { id: Date.now() + 2, name: 'Atelier', description: 'Outils et √©quipements' }
        ];
        saveToStorage();
    }

    function stopScanner() {
        if (html5QrCode) {
            return html5QrCode.stop().then(() => {
                html5QrCode.clear();
                html5QrCode = null;
                return true;
            }).catch(err => {
                console.log("Erreur arr√™t scanner:", err);
                html5QrCode = null;
                return false;
            });
        }
        return Promise.resolve(true);
    }

    function navigateTo(page) {
        // Arr√™ter proprement le scanner si on quitte la page scan
        if (html5QrCode && page !== 'scan') {
            stopScanner();
        }
        
        // Masquer toutes les pages
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        
        // Afficher la page demand√©e
        const targetPage = document.getElementById(`${page}-page`);
        if (targetPage) {
            targetPage.classList.remove('hidden');
        }
        
        // Mettre √† jour la navigation active
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        event.currentTarget?.classList.add('active');
        
        // Charger le contenu de la page
        if (page === 'dashboard') loadDashboard();
        if (page === 'inventory') loadInventory();
        if (page === 'scan') {
            // D√©marrer le scanner imm√©diatement
            setTimeout(() => {
                initScanner();
            }, 100);
        }
        if (page === 'search') loadSearchPage();
        if (page === 'locations') loadLocations();
    }

    function navigateToWithScanner(page) {
        if (page !== 'scan' && html5QrCode) {
            stopScanner().then(() => {
                navigateTo(page);
            });
        } else {
            navigateTo(page);
        }
    }

    function getNavLabelForPage(page) {
        const pageLabels = {
            'dashboard': 'Accueil',
            'inventory': 'Inventaire',
            'scan': 'Scanner',
            'search': 'Recherche',
            'locations': 'Lieux',
            'import-export': 'Export'
        };
        return pageLabels[page] || '';
    }

    function initScanner() {
        // Arr√™ter le scanner s'il est d√©j√† en cours
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                html5QrCode.clear();
                html5QrCode = null;
                initFreshScanner();
            }).catch(() => {
                html5QrCode = null;
                initFreshScanner();
            });
        } else {
            initFreshScanner();
        }
    }

    function initFreshScanner() {
        // V√©rifier qu'on est bien sur la page scan
        const scanPage = document.getElementById('scan-page');
        if (!scanPage || scanPage.classList.contains('hidden')) {
            console.log("Scanner: page non visible");
            return;
        }
        
        // Vider le conteneur
        const scannerContainer = document.getElementById('scanner-reader');
        scannerContainer.innerHTML = '';
        
        // Tester l'acc√®s cam√©ra
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "environment" } 
            })
            .then(function(stream) {
                stream.getTracks().forEach(track => track.stop());
                
                // Initialiser le scanner
                html5QrCode = new Html5QrcodeScanner(
                    "scanner-reader",
                    { 
                        fps: 10, 
                        qrbox: { width: 250, height: 150 },
                        aspectRatio: 1.0
                    },
                    false
                );
                
                html5QrCode.render(
                    (decodedText) => {
                        // Arr√™ter et traiter
                        if (html5QrCode) {
                            html5QrCode.stop().then(() => {
                                handleBarcodeScan(decodedText);
                            }).catch(() => {
                                handleBarcodeScan(decodedText);
                            });
                        }
                    },
                    (errorMessage) => {
                        // Ignorer les erreurs normales
                    }
                );
            })
            .catch(function(err) {
                console.error("Erreur cam√©ra:", err);
                scannerContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #888;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üì∑</div>
                        <div style="margin-bottom: 16px;">Acc√®s cam√©ra n√©cessaire</div>
                        <button class="btn-secondary" onclick="initScanner()">R√©essayer</button>
                    </div>
                `;
            });
        } else {
            scannerContainer.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #888;">
                    <div style="font-size: 48px; margin-bottom: 16px;">üì±</div>
                    <div>Navigateur incompatible</div>
                </div>
            `;
        }
    }

    function handleBarcodeScan(barcode) {
        document.getElementById('manual-barcode').value = barcode;
        const article = articles.find(a => a.barcode === barcode);
        
        if (article) {
            setTimeout(() => showArticleDetail(article.id), 300);
        } else {
            setTimeout(() => createArticleFromBarcode(barcode), 300);
        }
    }

    function searchByBarcode() {
        const barcode = document.getElementById('manual-barcode').value.trim();
        if (!barcode) {
            alert('Veuillez entrer un code-barre');
            return;
        }

        const article = articles.find(a => a.barcode === barcode);
        
        if (article) {
            showArticleDetail(article.id);
        } else {
            createArticleFromBarcode(barcode);
        }
    }

    function createArticleFromBarcode(barcode) {
        showAddArticleModal();
        document.getElementById('article-barcode').value = barcode;
        document.getElementById('article-famille').value = "boulonnerie";
        document.getElementById('article-categorie').value = "vis";
        document.getElementById('article-name').value = "hexa";
    }

    // ... reste des fonctions existantes (saveToStorage, addHistory, loadDashboard, etc.) ...

    document.addEventListener('DOMContentLoaded', () => {
        if (html5QrCode) {
            stopScanner();
        }
        
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', loadInventory);
        }
        
        const advancedSearchInput = document.getElementById('advanced-search-input');
        if (advancedSearchInput) {
            advancedSearchInput.addEventListener('input', performAdvancedSearch);
        }
        
        loadDashboard();
    });
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(reg => console.log('Service Worker registered'))
    .catch(err => console.error('Service Worker error:', err));
}
</script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9a725f727c0be112","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.9.1","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
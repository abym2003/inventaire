<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Scanner Cam√©ra</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
            background: #121212;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .scanner-container {
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin: 20px 0;
            position: relative;
        }
        #scanner-reader {
            width: 100%;
            height: 100%;
        }
        button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: #bb86fc;
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        button:active {
            opacity: 0.8;
        }
        .info {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .error {
            background: #cf6679;
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success {
            background: #03dac6;
            color: #000;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        input {
            width: 100%;
            padding: 12px;
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî∑ Test Scanner Cam√©ra</h1>
        
        <div id="status" class="info">
            Statut: En attente...
        </div>

        <button onclick="testCameraPermission()">
            1Ô∏è‚É£ Tester les permissions cam√©ra
        </button>

        <button onclick="startScanner()">
            2Ô∏è‚É£ D√©marrer le scanner
        </button>

        <button onclick="stopScanner()">
            ‚èπÔ∏è Arr√™ter le scanner
        </button>

        <div class="scanner-container">
            <div id="scanner-reader"></div>
        </div>

        <h3>Scanner manuel</h3>
        <input type="text" id="manual-input" placeholder="Entrez un code-barre manuellement">
        <button onclick="searchManual()">Rechercher</button>

        <div id="result"></div>

        <div class="info" style="margin-top: 30px;">
            <h3>‚ÑπÔ∏è Informations techniques</h3>
            <p id="tech-info">Chargement...</p>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        let html5QrCode = null;
        let isScanning = false;

        // Afficher les informations techniques
        window.onload = function() {
            const isSecure = window.location.protocol === 'https:' || window.location.hostname === 'localhost';
            const hasMediaDevices = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            
            document.getElementById('tech-info').innerHTML = `
                <strong>Protocole:</strong> ${window.location.protocol}<br>
                <strong>HTTPS:</strong> ${isSecure ? '‚úÖ Oui' : '‚ùå Non (REQUIS!)'}<br>
                <strong>API MediaDevices:</strong> ${hasMediaDevices ? '‚úÖ Disponible' : '‚ùå Non disponible'}<br>
                <strong>User Agent:</strong> ${navigator.userAgent.substring(0, 60)}...
            `;

            if (!isSecure && window.location.hostname !== 'localhost') {
                showError('‚ö†Ô∏è ATTENTION: Vous devez utiliser HTTPS pour acc√©der √† la cam√©ra!');
            }
        };

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = type;
            statusDiv.innerHTML = message;
        }

        function showError(message) {
            showStatus('‚ùå ' + message, 'error');
        }

        function showSuccess(message) {
            showStatus('‚úÖ ' + message, 'success');
        }

        function showResult(code) {
            document.getElementById('result').innerHTML = `
                <div class="success">
                    <h3>‚úÖ Code scann√©!</h3>
                    <p><strong>${code}</strong></p>
                </div>
            `;
        }

        // Fonction 1: Tester les permissions cam√©ra
        async function testCameraPermission() {
            showStatus('üîç Test des permissions cam√©ra...', 'info');
            
            try {
                // V√©rifier si l'API est disponible
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('L\'API MediaDevices n\'est pas disponible sur ce navigateur');
                }

                // Demander l'acc√®s √† la cam√©ra
                showStatus('üì∏ Demande d\'acc√®s √† la cam√©ra...', 'info');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    } 
                });

                showSuccess('Permission cam√©ra accord√©e! Vous pouvez maintenant d√©marrer le scanner.');
                
                // Arr√™ter le stream de test
                stream.getTracks().forEach(track => {
                    console.log('Track:', track.label, track.readyState);
                    track.stop();
                });

            } catch (error) {
                console.error('Erreur d√©taill√©e:', error);
                
                let errorMessage = 'Erreur: ' + error.message;
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = '‚ùå Permission refus√©e. Veuillez autoriser l\'acc√®s √† la cam√©ra dans les param√®tres de votre navigateur.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = '‚ùå Aucune cam√©ra trouv√©e sur cet appareil.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = '‚ùå La cam√©ra est d√©j√† utilis√©e par une autre application.';
                } else if (error.name === 'SecurityError') {
                    errorMessage = '‚ùå Erreur de s√©curit√©. Assurez-vous d\'utiliser HTTPS.';
                }
                
                showError(errorMessage);
            }
        }

        // Fonction 2: D√©marrer le scanner
        async function startScanner() {
            if (isScanning) {
                showError('Le scanner est d√©j√† actif!');
                return;
            }

            try {
                showStatus('üöÄ Initialisation du scanner...', 'info');

                // V√©rifier HTTPS
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                    throw new Error('HTTPS est requis pour utiliser la cam√©ra. Veuillez acc√©der au site via HTTPS.');
                }

                // Cr√©er le scanner s'il n'existe pas
                if (!html5QrCode) {
                    html5QrCode = new Html5QrcodeScanner(
                        "scanner-reader",
                        { 
                            fps: 10,
                            qrbox: { width: 250, height: 150 },
                            aspectRatio: 1.0,
                            rememberLastUsedCamera: true,
                            showTorchButtonIfSupported: true,
                            videoConstraints: {
                                facingMode: "environment"
                            }
                        },
                        false
                    );
                }

                // D√©marrer le rendu
                html5QrCode.render(
                    (decodedText) => {
                        console.log('Code scann√©:', decodedText);
                        showResult(decodedText);
                        document.getElementById('manual-input').value = decodedText;
                        // Ne pas arr√™ter automatiquement pour permettre plusieurs scans
                    },
                    (errorMessage) => {
                        // Ignorer les erreurs de scan continues (normal)
                    }
                );

                isScanning = true;
                showSuccess('Scanner activ√©! Pointez vers un code-barre.');

            } catch (error) {
                console.error('Erreur scanner:', error);
                showError('Impossible de d√©marrer le scanner: ' + error.message);
                isScanning = false;
            }
        }

        // Fonction 3: Arr√™ter le scanner
        function stopScanner() {
            if (!html5QrCode || !isScanning) {
                showError('Le scanner n\'est pas actif.');
                return;
            }

            try {
                html5QrCode.clear();
                isScanning = false;
                showStatus('Scanner arr√™t√©.', 'info');
            } catch (error) {
                console.error('Erreur lors de l\'arr√™t:', error);
                showError('Erreur lors de l\'arr√™t du scanner.');
            }
        }

        // Recherche manuelle
        function searchManual() {
            const code = document.getElementById('manual-input').value.trim();
            if (code) {
                showResult(code);
            } else {
                showError('Veuillez entrer un code-barre.');
            }
        }

        // Nettoyage √† la fermeture
        window.addEventListener('beforeunload', () => {
            if (html5QrCode && isScanning) {
                html5QrCode.clear();
            }
        });
    </script>
</body>
</html>